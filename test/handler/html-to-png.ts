import {APIGatewayProxyHandler, S3Handler} from 'aws-lambda'
import * as chromium from 'chrome-aws-lambda'
import * as path from 'path'
import {S3} from 'aws-sdk'

export const handler = (event, context, callback) => {
  if ('Records' in event) {
    return handleS3(event, context, callback)
  }
  return handleHttp(event, context, callback)
}

const handleHttp: APIGatewayProxyHandler = event => {
  return screenshot(event.body || html)
    .then(file => ({
      statusCode     : 201,
      body           : file,
      headers        : {
        'content-type'       : 'image/png',
        'content-disposition': 'attachment; filename=converted.png'
      },
      isBase64Encoded: true
    }))
    .catch(e => ({statusCode: 500, body: e.message}))
}
const handleS3: S3Handler = event => {
  return Promise.all(
    event.Records.map(async r => {
      const {bucket, object} = r.s3
      const {key, size} = object

      if (size > 0) {
        const file = await screenshot(html)

        console.log('f', file)

        if (file) {
          const {dir, name} = path.parse(key)
          const putKey = [dir, `${name}.png`].join('/')

          return s3
            .putObject({
              Bucket: bucket.name,
              Key   : putKey,
            })
            .promise()
        }
      }
      console.info(`skip: ${key} has size 0`)
    })
  ) as unknown as Promise<void>
}
const screenshot = async (html) => {
  let browser

  try {
    const {args, defaultViewport, executablePath, headless} = chromium
    browser = await chromium.puppeteer.launch({
      args,
      defaultViewport,
      headless,
      executablePath: await executablePath,
    })

    const page = await browser.newPage()
    await page.setContent(html)
    const file = await page.screenshot({encoding: 'base64'})

    return file
  } finally {
    if (browser) {
      await browser.close()
    }
  }
}

const html = '<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/X3RRWv_TTak4ekqJM6TP7/pages/daily-youtuber.js" as="script"/><link rel="preload" href="/_next/static/X3RRWv_TTak4ekqJM6TP7/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-035ac2b14bde147cb4a8.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.6dd1c0831e422c0958a5.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-d76e12bcf8648e38b88e.js" as="script"/></head><body><div id="__next"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.11.1/tachyons.min.css"/><link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"/><div class="flex flex-column"><h1>♥️ 일간 구독자 증가율 TOP 10</h1><ul><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">1</div><div class="dib w-10"><i class="fas fa-arrow-alt-circle-up red"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l79w3oQTvVzbqRQKUEJ_teiEx8N0jQCFAjYwIg=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">JFlaMusic</div><div class="dib w-20">14100000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">2</div><div class="dib w-10"><i class="fas fa-arrow-alt-circle-up red"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l7-DJgdbdrV5zDLRvpZEy5I07sdzJMpg3dhOkw=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">BT21</div><div class="dib w-20">2470000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">3</div><div class="dib w-10"><i class="fas fa-arrow-alt-circle-up red"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l7_LnHpn0KISu9DHsZs22BQIdPvDcnj8kXPloA=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">TWICE</div><div class="dib w-20">6190000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">3</div><div class="dib w-10"><i class="fas fa-arrow-alt-circle-up red"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l79CDY5Estq-ri66vAsYLZlbXsic5HDRhfVzBQ=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">SBS KPOP PLAY</div><div class="dib w-20">3200000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">5</div><div class="dib w-10"><i class="fas fa-minus-circle black"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l7-yi7M7SKzLqaaKMNjPGmy3JmcwNxhhnRfcEA=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">Jane ASMR 제인</div><div class="dib w-20">4560000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">5</div><div class="dib w-10"><i class="fas fa-minus-circle black"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l7-qKN9yADZptFxQFjiG6fcoaklpS2-3p9lLgA=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">쏘영 Ssoyoung</div><div class="dib w-20">2020000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">5</div><div class="dib w-10"><i class="fas fa-minus-circle black"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l785mNl8UGV5i3DeCjBxNngKDLCAo1t3Sc1Xtg=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">자이언트 펭TV</div><div class="dib w-20">1500000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">8</div><div class="dib w-10"><i class="fas fa-arrow-alt-circle-up red"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l78zwc8HCZAq5iMDzCuglmU535R6UrlHf8ljYA=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">채널 NCT MUSIC</div><div class="dib w-20">936000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">9</div><div class="dib w-10"><i class="fas fa-minus-circle black"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l79dhhzvhelpBbp6vVVclpYa45tavp0ZUKNI2Q=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">소련여자 Soviet girl in Seoul</div><div class="dib w-20">737000<!-- --> 명</div></div></li><li class="mv2 flex flex-column w-100"><div class="flex-auto flex-column flex-auto justify-center pl2"><div class="dib w-10 b">10</div><div class="dib w-10"><i class="fas fa-arrow-alt-circle-down blue"></i></div><div class="dib w-20"><img class="v-mid br-100 ba h3 w3 hot-pink" src="https://yt3.ggpht.com/a/AGF-l7-XnPwEPTug8IR3vZPMydx6nHajDRd-8ZA7OQ=s88-c-k-c0xffffffff-no-rj-mo" alt="로고"/></div><div class="dib w-40">짧은대본</div><div class="dib w-20">229000<!-- --> 명</div></div></li></ul></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{"data":[{"categoryRank":1,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#music#subscriber#daily#2909-1#97-1","hk":"UClkRzsdvg7_RKVhwDwiDZOA","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#music#subscriber#daily","channel":{"title":"JFlaMusic","country":"","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l79w3oQTvVzbqRQKUEJ_teiEx8N0jQCFAjYwIg=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l79w3oQTvVzbqRQKUEJ_teiEx8N0jQCFAjYwIg=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":14100000,"view":2563883209,"video":244},"prev":{"subscriber":14000000,"view":2562571445,"video":244},"inc":{"subscriber":100000,"view":1311764,"video":0}}},"rank":1,"categoryChart":"music#subscriber#daily"},{"categoryRank":1,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#film#subscriber#daily#3-2#1-1","hk":"UCINr5W7cwW06ADtsszAToAw","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#film#subscriber#daily","channel":{"title":"BT21","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l7-DJgdbdrV5zDLRvpZEy5I07sdzJMpg3dhOkw=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l7-DJgdbdrV5zDLRvpZEy5I07sdzJMpg3dhOkw=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":2470000,"view":124989123,"video":105},"prev":{"subscriber":2430000,"view":123649296,"video":105},"inc":{"subscriber":40000,"view":1339827,"video":0}}},"rank":2,"categoryChart":"film#subscriber#daily"},{"categoryRank":1,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#entertainment#subscriber#daily#4-3#2-1","hk":"UCzgxx_DM2Dcb9Y1spb9mUJA","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#entertainment#subscriber#daily","channel":{"title":"TWICE","country":"","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l7_LnHpn0KISu9DHsZs22BQIdPvDcnj8kXPloA=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l7_LnHpn0KISu9DHsZs22BQIdPvDcnj8kXPloA=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":6190000,"view":650129684,"video":263},"prev":{"subscriber":6160000,"view":647717699,"video":262},"inc":{"subscriber":30000,"view":2411985,"video":1}}},"rank":3,"categoryChart":"entertainment#subscriber#daily"},{"categoryRank":1,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#entertainment#subscriber#daily#2909-3#47-1","hk":"UCS_hnpJLQTvBkqALgapi_4g","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#entertainment#subscriber#daily","channel":{"title":"SBS KPOP PLAY","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l79CDY5Estq-ri66vAsYLZlbXsic5HDRhfVzBQ=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l79CDY5Estq-ri66vAsYLZlbXsic5HDRhfVzBQ=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":3200000,"view":1721788261,"video":17813},"prev":{"subscriber":3170000,"view":1720345249,"video":17810},"inc":{"subscriber":30000,"view":1443012,"video":3}}},"rank":3,"categoryChart":"entertainment#subscriber#daily"},{"categoryRank":1,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#unknown#subscriber#daily#5-5#1-1","hk":"UC2fsxQr6Hcx1enORxXgKpxQ","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#unknown#subscriber#daily","channel":{"title":"Jane ASMR 제인","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l7-yi7M7SKzLqaaKMNjPGmy3JmcwNxhhnRfcEA=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l7-yi7M7SKzLqaaKMNjPGmy3JmcwNxhhnRfcEA=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":4560000,"view":1019206361,"video":587},"prev":{"subscriber":4540000,"view":1014080868,"video":586},"inc":{"subscriber":20000,"view":5125493,"video":1}}},"rank":5,"categoryChart":"unknown#subscriber#daily"},{"categoryRank":1,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#asmr#subscriber#daily#5-5#1-1","hk":"UC4PpFUrfT2Pou7OwpVF0MUQ","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#asmr#subscriber#daily","channel":{"title":"쏘영 Ssoyoung","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l7-qKN9yADZptFxQFjiG6fcoaklpS2-3p9lLgA=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l7-qKN9yADZptFxQFjiG6fcoaklpS2-3p9lLgA=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":2020000,"view":193857009,"video":245},"prev":{"subscriber":2000000,"view":190811235,"video":244},"inc":{"subscriber":20000,"view":3045774,"video":1}}},"rank":5,"categoryChart":"asmr#subscriber#daily"},{"categoryRank":1,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#unknown#subscriber#daily#5-5#1-1","hk":"UCtckgmUcpzqGnzcs7xEqMzQ","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#unknown#subscriber#daily","channel":{"title":"자이언트 펭TV","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l785mNl8UGV5i3DeCjBxNngKDLCAo1t3Sc1Xtg=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l785mNl8UGV5i3DeCjBxNngKDLCAo1t3Sc1Xtg=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":1500000,"view":112401476,"video":140},"prev":{"subscriber":1480000,"view":110178008,"video":139},"inc":{"subscriber":20000,"view":2223468,"video":1}}},"rank":5,"categoryChart":"unknown#subscriber#daily"},{"categoryRank":3,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#unknown#subscriber#daily#167-8#75-3","hk":"UC6_kmAF-67rCiIpa3dCit5A","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#unknown#subscriber#daily","channel":{"title":"채널 NCT MUSIC","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l78zwc8HCZAq5iMDzCuglmU535R6UrlHf8ljYA=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l78zwc8HCZAq5iMDzCuglmU535R6UrlHf8ljYA=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":936000,"view":40931293,"video":23},"prev":{"subscriber":919000,"view":40075998,"video":20},"inc":{"subscriber":17000,"view":855295,"video":3}}},"rank":8,"categoryChart":"unknown#subscriber#daily"},{"categoryRank":4,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#unknown#subscriber#daily#9-9#4-4","hk":"UC7Krez5EI8pXKHnYWsE-zUw","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#unknown#subscriber#daily","channel":{"title":"소련여자 Soviet girl in Seoul","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l79dhhzvhelpBbp6vVVclpYa45tavp0ZUKNI2Q=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l79dhhzvhelpBbp6vVVclpYa45tavp0ZUKNI2Q=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":737000,"view":40041588,"video":36},"prev":{"subscriber":723000,"view":39218961,"video":36},"inc":{"subscriber":14000,"view":822627,"video":0}}},"rank":9,"categoryChart":"unknown#subscriber#daily"},{"categoryRank":5,"c":"2019-12-25T07:30:00.000Z","t":"channel#chart#unknown#subscriber#daily#8-10#3-5","hk":"UChgOgRNxrtCcVARDQT_c-Zg","chart":"subscriber#daily","ttl":1577345400,"rk":"chart#unknown#subscriber#daily","channel":{"title":"짧은대본","country":"KR","thumbnail":{"d":"https://yt3.ggpht.com/a/AGF-l7-XnPwEPTug8IR3vZPMydx6nHajDRd-8ZA7OQ=s88-c-k-c0xffffffff-no-rj-mo","m":"https://yt3.ggpht.com/a/AGF-l7-XnPwEPTug8IR3vZPMydx6nHajDRd-8ZA7OQ=s240-c-k-c0xffffffff-no-rj-mo"},"stats":{"curr":{"subscriber":229000,"view":17030839,"video":39},"prev":{"subscriber":217000,"view":15742092,"video":39},"inc":{"subscriber":12000,"view":1288747,"video":0}}},"rank":10,"categoryChart":"unknown#subscriber#daily"}]}},"page":"/daily-youtuber","query":{},"buildId":"X3RRWv_TTak4ekqJM6TP7","nextExport":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-59d32c5e0ed3dd797824.js"></script><script async="" data-next-page="/daily-youtuber" src="/_next/static/X3RRWv_TTak4ekqJM6TP7/pages/daily-youtuber.js"></script><script async="" data-next-page="/_app" src="/_next/static/X3RRWv_TTak4ekqJM6TP7/pages/_app.js"></script><script src="/_next/static/runtime/webpack-035ac2b14bde147cb4a8.js" async=""></script><script src="/_next/static/chunks/commons.6dd1c0831e422c0958a5.js" async=""></script><script src="/_next/static/runtime/main-d76e12bcf8648e38b88e.js" async=""></script></body></html>'
const s3 = new S3({region: 'ap-northeast-2'})
